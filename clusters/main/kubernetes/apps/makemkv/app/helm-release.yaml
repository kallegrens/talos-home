---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: makemkv
  namespace: makemkv
spec:
  postRenderers:
    - kustomize:
        patches:
          # Patch 1: Add the resource limit for the bluray device
          - target:
              version: v1
              # IMPORTANT: Change 'Deployment' if MakeMKV uses a StatefulSet or other kind
              kind: Deployment
              # IMPORTANT: Change 'makemkv' to the exact name of your MakeMKV Deployment/StatefulSet
              name: makemkv
            patch: |
              - op: add
                # IMPORTANT: Change '0' if your MakeMKV container is not the first one (e.g., '1')
                # Note: truecharts.org~1bluray is the JSON patch encoding for "truecharts.org/bluray"
                path: /spec/template/spec/containers/0/resources/limits/truecharts.org~1bluray
                value: 1 # Request 1 unit of the bluray device

          # Patch 2: Add the resource request for the bluray device (Recommended)
          - target:
              version: v1
              # IMPORTANT: Change 'Deployment' if MakeMKV uses a StatefulSet or other kind
              kind: Deployment
              # IMPORTANT: Change 'makemkv' to the exact name of your MakeMKV Deployment/StatefulSet
              name: makemkv
            patch: |
              - op: add
                # IMPORTANT: Change '0' if your MakeMKV container is not the first one (e.g., '1')
                path: /spec/template/spec/containers/0/resources/requests/truecharts.org~1bluray
                value: 1 # Request 1 unit of the bluray device
  interval: 15m
  chart:
    spec:
      chart: makemkv
      version: 13.1.1
      sourceRef:
        kind: HelmRepository
        name: truecharts
        namespace: flux-system
      interval: 15m
  timeout: 20m
  maxHistory: 3
  driftDetection:
    mode: warn
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    TZ: Europe/Stockholm

    ingress:
      main:
        enabled: true
        integrations:
          traefik:
            enabled: true
          certManager:
            enabled: true
            certificateIssuer: domain-0-le-prod
        hosts:
          - host: makemkv.${DOMAIN_0}

    persistence:
      output:
        type: nfs
        server: ${NFS_IP}
        path: /mnt/lundgrens_data/plex-media/Unindexed

    makemkv:
      KEEP_APP_RUNNING: true
      DARK_MODE: true
      MAKEMKV_KEY: ${MAKEMKV_KEY}
      AUTO_DISC_RIPPER: true
      AUTO_DISC_RIPPER_EJECT: true
      AUTO_DISC_RIPPER_FORCE_UNIQUE_OUTPUT_DIR: true
      DISPLAY_WIDTH: 1920
      DISPLAY_HEIGHT: 1080