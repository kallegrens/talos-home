apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: arc-github-webhook
  namespace: actions-runner-system
  annotations:
    cert-manager.io/cluster-issuer: domain-0-le-prod
    cert-manager.io/private-key-rotation-policy: Always

    # Optional small payloads; helps avoid abuse (tweak as needed)
    # nginx.ingress.kubernetes.io/proxy-body-size: "1m"
    # nginx.ingress.kubernetes.io/limit-rps: "5"

    # 1) Force HTTPS
    nginx.ingress.kubernetes.io/ssl-redirect: "true"

    # 2) Only allow GitHub webhook IPs (keep this list updated)
    nginx.ingress.kubernetes.io/whitelist-source-range: "${GITHUB_WEBHOOK_CIDRS}"

    # 3) (Nice & cheap) allow POST only
    nginx.ingress.kubernetes.io/server-snippet: |
      if ($request_method !~ ^POST$) { return 405; }

spec:
  ingressClassName: external
  rules:
    - host: arc-webhook.${DOMAIN_0}
      http:
        paths:
          - pathType: Prefix
            path: /actions-runner-controller-github-webhook
            backend:
              service:
                name: actions-runner-controller-github-webhook
                port:
                  number: 80
  tls:
    - hosts:
        - arc-webhook.${DOMAIN_0}
      secretName: arc-github-webhook-tls-0
